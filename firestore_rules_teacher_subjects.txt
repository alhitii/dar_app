// ğŸ”’ Firestore Security Rules - Teacher Subjects Validation
// Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ù‰ firestore.rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function isTeacher() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø¶Ù…Ù† Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…
    function teacherHasSubject(subjectId) {
      let teacherDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return subjectId in teacherDoc.data.subjects;
    }
    
    // Ù‚ÙˆØ§Ø¹Ø¯ collection Ø§Ù„Ù…ÙˆØ§Ø¯
    match /subjects/{subjectId} {
      // Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
      allow read: if request.auth != null;
      
      // ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙŠÙ…ÙƒÙ†Ù‡Ø§ Ø§Ù„ÙƒØªØ§Ø¨Ø©
      allow write: if isAdmin();
    }
    
    // Ù‚ÙˆØ§Ø¹Ø¯ collection Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    match /users/{userId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      allow read: if request.auth.uid == userId || isAdmin();
      
      // Ø§Ù„ÙƒØªØ§Ø¨Ø©: ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      allow write: if isAdmin();
    }
    
    // Ù‚ÙˆØ§Ø¹Ø¯ collection Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
    match /assignments/{assignmentId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø¬Ù…ÙŠØ¹
      allow read: if request.auth != null;
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†
      allow create: if isTeacher() && 
                      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø§Ø¯Ø© Ø¶Ù…Ù† Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…
                      teacherHasSubject(request.resource.data.subjectId) &&
                      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                      request.resource.data.keys().hasAll([
                        'subjectId', 'title', 'description', 
                        'dueDate', 'createdBy', 'createdAt'
                      ]);
      
      // Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙÙ‚Ø· Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù‡
      allow update: if isTeacher() && 
                      resource.data.createdBy == request.auth.uid &&
                      // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ù…Ø§Ø¯Ø© Ø®Ø§Ø±Ø¬ Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…
                      teacherHasSubject(request.resource.data.subjectId);
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù‡ Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      allow delete: if (isTeacher() && resource.data.createdBy == request.auth.uid) || 
                      isAdmin();
    }
    
    // Ù‚ÙˆØ§Ø¹Ø¯ collection Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    match /notifications/{notificationId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ† Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      allow read: if request.auth != null && 
                    (resource.data.teacherId == request.auth.uid || 
                     resource.data.targetRole == 'admin' ||
                     isAdmin());
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨Ø§Øª
      allow create: if request.auth != null;
      
      // Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© read)
      allow update: if isAdmin();
      
      // Ø§Ù„Ø­Ø°Ù: ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
      allow delete: if isAdmin();
    }
  }
}

// ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:
// 1. ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ù† ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ø¨ Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø© Ø®Ø§Ø±Ø¬ subjects
// 2. ØªØ³Ù…Ø­ Ø¨Ø·Ù„Ø¨Ø§Øª ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
// 3. ÙÙ‚Ø· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙŠÙ…ÙƒÙ†Ù‡Ø§ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
// 4. Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¯ÙŠÙ‡Ø§ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©

// ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙÙŠ Firebase Console:
// 1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firestore â†’ Rules â†’ Test Rules
// 2. Ø¬Ø±Ù‘Ø¨ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ù…Ø®ØªÙ„ÙØ©:
//    - Ù…Ø¹Ù„Ù… ÙŠØ­Ø§ÙˆÙ„ ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ø¨ Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø© Ù„ÙŠØ³Øª Ù„Ù‡
//    - Ù…Ø¹Ù„Ù… ÙŠØ­Ø§ÙˆÙ„ ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ø¨ Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø© Ù„Ù‡
//    - Ø·Ø§Ù„Ø¨ ÙŠØ­Ø§ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ù„Ù…
