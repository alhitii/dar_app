# ๐งช ุฏููู ุชูุณูุน ุงูุตูุงุญูุงุช ุงููุคูุช ููุงุฎุชุจุงุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุธุงู ูุชูุญ ุชูุณูุน ุตูุงุญูุงุช ุฌููุน ุงููุนูููู ูุคูุชุงู ูุฃุบุฑุงุถ ุงูุงุฎุชุจุงุฑุ ูุน ุฅููุงููุฉ ุงูุงุณุชุฑุฌุงุน ุงููุงูู.

---

## ๐ฏ ุงููุฏู

**ุงูุณููุงุฑูู:**
- ุชุฑูุฏ ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุงููุงุฌุจุงุช ูุฌููุน ุงูููุงุฏ/ุงูุตููู/ุงูุดุนุจ
- ููู ุงููุนูููู ูุญุฏูุฏูู ุจููุงุฏ ูุตููู ูุนููุฉ
- ุชุญุชุงุฌ ุชูุณูุน ูุคูุช ุจุฏูู ููุฏุงู ุงูุจูุงูุงุช ุงูุฃุตููุฉ

**ุงูุญู:**
- ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช ุงูุญุณุงุณุฉ โ
- ุชูุณูุน ุงูุตูุงุญูุงุช ููู ุงููุนูููู โ
- ุงุฎุชุจุงุฑ ุดุงูู โ
- ุงุณุชุฑุฌุงุน ุงูุญุงูุฉ ุงูุฃุตููุฉ โ

---

## ๐๏ธ ุจููุฉ ุงููุธุงู

### **1. Collections ุงููุณุชุฎุฏูุฉ:**

```
users/
โโโ {teacherId}/
โ   โโโ subjects: [...ids]          โ ูุชู ุชูุณูุนู
โ   โโโ classes: [...ids]           โ ูุชู ุชูุณูุนู
โ   โโโ sections: [...ids]          โ ูุชู ุชูุณูุนู
โ   โโโ scopesTemporary: true       โ ุนูุงูุฉ ุงูุชูุณูุน

backups_users/
โโโ {teacherId}/
โ   โโโ subjects: [...original]     โ ุงููุณุฎุฉ ุงูุฃุตููุฉ
โ   โโโ classes: [...original]      
โ   โโโ sections: [...original]     
โ   โโโ backedUpAt: timestamp       

logs/
โโโ {logId}/
    โโโ operation: "expandScopes"
    โโโ data: {...results}
    โโโ timestamp: ...
```

---

## ๐ ุฏููู ุงูุงุณุชุฎุฏุงู

### **ุงูุทุฑููุฉ 1: ุนุจุฑ ุงููุงุฌูุฉ (ููุตู ุจู)**

#### **ุงูุฎุทูุฉ 1: ุงููุตูู ูููุงุฌูุฉ**

```dart
// ูู ููุญุฉ ุงูุฅุฏุงุฑุฉุ ุฃุถู ุฒุฑ:
ElevatedButton.icon(
  onPressed: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => TemporaryScopeManager(),
      ),
    );
  },
  icon: Icon(Icons.science),
  label: Text('ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑ ุงููุคูุช'),
)
```

#### **ุงูุฎุทูุฉ 2: ุชูุนูู Feature Flag**

1. ุงูุชุญ **"ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑ ุงููุคูุช"**
2. ูุนูู ุงูููุชุงุญ: **"ูุถุน ุงูุงุฎุชุจุงุฑ ุงูุดุงูู"**
3. ุชุญูู ูู ุชุญูู ุงูุญุงูุฉ ุฅูู "ูุดุท"

#### **ุงูุฎุทูุฉ 3: ุชูุณูุน ุงูุตูุงุญูุงุช**

1. ุงุถุบุท **"ุชูุณูุน ุงูุตูุงุญูุงุช"**
2. ุฃููุฏ ุงูุชูููุฐ
3. ุงูุชุธุฑ (5-10 ุฏูุงุฆู ุญุณุจ ุนุฏุฏ ุงููุนูููู)
4. ุดุงูุฏ ุงููุชุงุฆุฌ:
   ```
   ุฅุฌูุงูู ุงููุนูููู: 20
   ูุฌุญ: 20
   ูุดู: 0
   ุงููุฏุฉ: 45 ุซุงููุฉ
   ุงูููุงุฏ: 10
   ุงูุตููู: 9
   ุงูุดุนุจ: 6
   ```

#### **ุงูุฎุทูุฉ 4: ุงูุงุฎุชุจุงุฑ**

ุงูุขู ูู ูุนูู ููููู:
- โ ุฑุคูุฉ ุฌููุน ุงูููุงุฏ
- โ ุงุฎุชูุงุฑ ุฃู ุตู
- โ ุงุฎุชูุงุฑ ุฃู ุดุนุจุฉ
- โ ุฅุฑุณุงู ูุงุฌุจุงุช ููู ุงูุทูุงุจ

**ุฌุฑูุจ:**
1. ุณุฌูู ุฏุฎูู ููุนูู
2. ุงูุชุญ "ุฅุฑุณุงู ูุงุฌุจ"
3. ุงุฎุชุฑ ุฃู ูุงุฏุฉ/ุตู/ุดุนุจุฉ
4. ุฃุฑุณู ุงููุงุฌุจ
5. ุชุญูู ูู ูุตููู ููุทูุงุจ

#### **ุงูุฎุทูุฉ 5: ุงุณุชุฑุฌุงุน ุงูุตูุงุญูุงุช**

ุจุนุฏ ุงูุชูุงุก ุงูุงุฎุชุจุงุฑ:

1. ุงุฑุฌุน ูู **"ุฅุฏุงุฑุฉ ุงูุงุฎุชุจุงุฑ ุงููุคูุช"**
2. ุงุถุบุท **"ุงุณุชุฑุฌุงุน ุงูุตูุงุญูุงุช ุงูุฃุตููุฉ"**
3. ุฃููุฏ ุงูุชูููุฐ
4. ุงูุชุธุฑ ุงููุชุงุฆุฌ:
   ```
   ุฅุฌูุงูู ุงููุนูููู: 20
   ูุฌุญ: 20
   ูุดู: 0
   ุงููุฏุฉ: 30 ุซุงููุฉ
   ```
5. โ ุชู! ุนุงุฏุช ุงูุตูุงุญูุงุช ููุง ูุงูุช

#### **ุงูุฎุทูุฉ 6: ุญุฐู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ (ุงุฎุชูุงุฑู)**

ุจุนุฏ ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุงุณุชุฑุฌุงุน:

1. ุงุถุบุท **"ุญุฐู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ"**
2. ุฃููุฏ ุงูุญุฐู
3. โ ุชู ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### **ุงูุทุฑููุฉ 2: ุนุจุฑ ุงูููุฏ (ูููุทูุฑูู)**

```dart
import 'package:madrasah/services/temporary_scope_expansion_service.dart';

// 1. ุชูุณูุน ุงูุตูุงุญูุงุช
final expandResult = await TemporaryScopeExpansionService.expandScopesTemporarily();
print('ูุฌุญ: ${expandResult['successCount']}');

// 2. ูุญุต ุงูุญุงูุฉ
final status = await TemporaryScopeExpansionService.getSystemStatus();
print('ูุนูููู ุจุตูุงุญูุงุช ููุณุนุฉ: ${status['teachersWithTempScopes']}');

// 3. ุงุณุชุฑุฌุงุน ุงูุตูุงุญูุงุช
final rollbackResult = await TemporaryScopeExpansionService.rollbackTeacherScopes();
print('ุชู ุงุณุชุฑุฌุงุน: ${rollbackResult['successCount']} ูุนูู');

// 4. ุญุฐู ุงููุณุฎ
final cleanupResult = await TemporaryScopeExpansionService.cleanupBackups();
print('ุชู ุญุฐู: ${cleanupResult['deletedCount']} ูุณุฎุฉ');
```

---

## ๐ ูุซุงู ุนูู ุงูุณูุฑ ุงููุงูู

### **ูุจู ุงูุชูุณูุน:**

```
ุงููุนูู ุฃุญูุฏ:
- subjects: ['math', 'physics']
- classes: ['grade3']
- sections: ['A', 'B']
```

### **ุจุนุฏ ุงูุชูุณูุน:**

```
ุงููุนูู ุฃุญูุฏ:
- subjects: ['math', 'physics', 'arabic', 'english', ...]  โ ูู ุงูููุงุฏ
- classes: ['grade1', 'grade2', 'grade3', ...]            โ ูู ุงูุตููู
- sections: ['A', 'B', 'C', 'D', ...]                     โ ูู ุงูุดุนุจ
- scopesTemporary: true                                    โ ุนูุงูุฉ

ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ูู backups_users/ahmad:
- subjects: ['math', 'physics']                            โ ุงูุฃุตููุฉ
- classes: ['grade3']
- sections: ['A', 'B']
```

### **ุจุนุฏ ุงูุงุณุชุฑุฌุงุน:**

```
ุงููุนูู ุฃุญูุฏ:
- subjects: ['math', 'physics']      โ ุนุงุฏุช ููุฃุตููุฉ โ
- classes: ['grade3']
- sections: ['A', 'B']
- scopesTemporary: deleted           โ ุชู ุงูุญุฐู
```

---

## ๐ ููุงุนุฏ ุงูุฃูุงู

### **Firestore Security Rules:**

```javascript
// ุญูุงูุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
match /backups_users/{userId} {
  // ุงูุฅุฏุงุฑุฉ ููุท
  allow read, write: if request.auth != null && isAdmin();
}

// ุณุฌูุงุช ุงูุนูููุงุช
match /logs/{logId} {
  // ุงูุฅุฏุงุฑุฉ ูููุฑุงุกุฉุ ุงููุธุงู ูููุชุงุจุฉ
  allow read: if request.auth != null && isAdmin();
  allow create: if request.auth != null;
  allow update, delete: if false;
}

// ุฅุนุฏุงุฏุงุช Feature Flags
match /settings/features {
  // ุงูุฅุฏุงุฑุฉ ููุท
  allow read: if request.auth != null;
  allow write: if request.auth != null && isAdmin();
}

function isAdmin() {
  return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
```

---

## ๐งช ุฎุทุฉ ุงูุงุฎุชุจุงุฑ

### **ุงูุณููุงุฑูู 1: ุชูุณูุน ูุฅุฑุณุงู ูุงุฌุจ**

```
1. โ ุชูุนูู Feature Flag
2. โ ุชูุณูุน ุงูุตูุงุญูุงุช
3. โ ุณุฌูู ุฏุฎูู ููุนูู ุฑูุงุถูุงุช
4. โ ุงุฎุชุฑ ูุงุฏุฉ "ุงูุนุฑุจู" (ูู ุชูู ูุชุงุญุฉ ุณุงุจูุงู)
5. โ ุงุฎุชุฑ ุตู "ุงูุฃูู" (ูู ููู ูุชุงุญุงู)
6. โ ุงุฎุชุฑ ุดุนุจุฉ "D" (ูู ุชูู ูุชุงุญุฉ)
7. โ ุฃุฑุณู ูุงุฌุจ
8. โ ุชุญูู ูู ูุตููู ููุทูุงุจ ุงููุทุงุจููู
```

### **ุงูุณููุงุฑูู 2: ุงุณุชุฑุฌุงุน ุจุนุฏ ุงูุงุฎุชุจุงุฑ**

```
1. โ ุงุณุชุฑุฌุงุน ุงูุตูุงุญูุงุช
2. โ ุณุฌูู ุฏุฎูู ูููุณ ุงููุนูู
3. โ ุชุญูู ูู ุงุฎุชูุงุก ุงูููุงุฏ/ุงูุตููู/ุงูุดุนุจ ุงูุฅุถุงููุฉ
4. โ ุชุญูู ูู ุจูุงุก ุงูููุงุฏ ุงูุฃุตููุฉ ููุท
5. โ ุชุญูู ูู ุนุฏู ูุฌูุฏ ุนูุงูุฉ scopesTemporary
```

### **ุงูุณููุงุฑูู 3: ูุญุต ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ**

```
1. โ ุงูุชุญ Firestore Console
2. โ ุงูุญุต backups_users collection
3. โ ุชุญูู ูู ูุฌูุฏ ูุณุฎุฉ ููู ูุนูู
4. โ ุชุญูู ูู ุงุญุชูุงุก ุงูุจูุงูุงุช ุงูุฃุตููุฉ
5. โ ุชุญูู ูู timestamp
```

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### **Logs ุงููุชุงุญุฉ:**

```javascript
// ูู collection: logs
{
  operation: "expandScopes",
  data: {
    totalTeachers: 20,
    successCount: 20,
    failCount: 0,
    duration: 45,
    subjects: 10,
    classes: 9,
    sections: 6
  },
  timestamp: "2025-01-25T10:30:00Z"
}
```

### **ุงุณุชุนูุงู Logs:**

```dart
// ุฃุญุฏุซ ุนูููุงุช ุงูุชูุณูุน
final logs = await FirebaseFirestore.instance
    .collection('logs')
    .where('operation', isEqualTo: 'expandScopes')
    .orderBy('timestamp', descending: true)
    .limit(10)
    .get();
```

---

## โ๏ธ ุชุญุฐูุฑุงุช ูููุฉ

### **1. ุจูุฆุฉ ุงูุงุณุชุฎุฏุงู:**
```
โ ุจูุฆุฉ ุงูุชุทููุฑ
โ ุจูุฆุฉ ุงูุงุฎุชุจุงุฑ
โ ุจูุฆุฉ ุงูุฅูุชุงุฌ (ุฅูุง ุจุญุฐุฑ ุดุฏูุฏ)
```

### **2. ุงูุฏูุนุงุช (Batching):**
```dart
// ุฅุฐุง ูุงู ุนุฏุฏ ุงููุนูููู > 100
// ุฃุถู ุชุฃุฎูุฑ ุจูู ุงูุฏูุนุงุช:
if ((i + 1) % 10 == 0) {
  await Future.delayed(Duration(milliseconds: 500));
}
```

### **3. ุญุฏูุฏ Firestore:**
```
- ุงููุฑุงุกุฉ/ุงููุชุงุจุฉ: 10,000 ุนูููุฉ/ุซุงููุฉ
- ุญุฌู ุงููุซููุฉ: 1 MB
- whereIn: 10 ุนูุงุตุฑ ูุญุฏ ุฃูุตู
```

### **4. ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ:**
```
- ูุง ุชุญุฐู ูุจู ุงูุงุณุชุฑุฌุงุน โ
- ุชุญูู ูู ูุฌุงุญ ุงูุงุณุชุฑุฌุงุน ุฃููุงู โ
- ุงุญุชูุธ ุจูุณุฎุฉ ุฎุงุฑุฌูุฉ ููุถูุงู โ
```

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **ุงููุดููุฉ 1: "ูุง ุชูุฌุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ"**

```dart
// ุงูุณุจุจ: ุชู ุญุฐู ุงููุณุฎุฉ ูุจู ุงูุงุณุชุฑุฌุงุน
// ุงูุญู: ุงุณุชุฎุฏู Firebase Console ููุงุณุชุฑุฌุงุน ุงููุฏูู
```

### **ุงููุดููุฉ 2: "ุจุนุถ ุงููุนูููู ูู ูุชู ุชูุณูุนูู"**

```dart
// ุงูุณุจุจ: ุฎุทุฃ ูู ุงูุจูุงูุงุช ุฃู ุญุฏูุฏ ุงููุนุฏู
// ุงูุญู: ุงูุญุต logs ูุฃุนุฏ ุงูุชุดุบูู ูููุชุจููู
final failedTeachers = expandResult['errors'];
for (final error in failedTeachers) {
  print('ุฎุทุฃ: $error');
}
```

### **ุงููุดููุฉ 3: "Feature Flag ูุง ูุนูู"**

```dart
// ุงูุณุจุจ: ุงููุณุชูุฏ ุบูุฑ ููุฌูุฏ
// ุงูุญู: ุฃูุดุฆ ูุฏููุงู
await FirebaseFirestore.instance
    .collection('settings')
    .doc('features')
    .set({
  'autoTestAllScopes': false,
  'createdAt': FieldValue.serverTimestamp(),
});
```

---

## ๐ Checklist ูุจู ุงูุฅูุชุงุฌ

- [ ] โ ุชู ุงุฎุชุจุงุฑ ุงูุชูุณูุน ูู ุจูุฆุฉ ุงูุชุทููุฑ
- [ ] โ ุชู ุงุฎุชุจุงุฑ ุงูุงุณุชุฑุฌุงุน ุจูุฌุงุญ
- [ ] โ ุชู ุงูุชุญูู ูู ุนุฏู ููุฏุงู ุจูุงูุงุช
- [ ] โ ุชู ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุงููุงุฌุจุงุช
- [ ] โ ุชู ูุญุต logs ูุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] โ ุชู ุชุทุจูู Security Rules
- [ ] โ ุชู ุชูุซูู ุงูุนูููุฉ
- [ ] โ ุชู ุชุฏุฑูุจ ุงููุฑูู
- [ ] โ๏ธ ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุฎุงุฑุฌู ููุฌูุฏ
- [ ] โ๏ธ ุฎุทุฉ ุงูุทูุงุฑุฆ ุฌุงูุฒุฉ

---

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

| ุงูููู | ุงููุตู |
|------|-------|
| `lib/services/temporary_scope_expansion_service.dart` | ุงูุณูุฑุจุชุงุช ุงูุฃุณุงุณูุฉ |
| `lib/ui/admin/temporary_scope_manager.dart` | ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ |
| `TEMPORARY_SCOPE_EXPANSION_GUIDE.md` | ูุฐุง ุงูููู |

---

## ๐ ุงูุฎูุงุตุฉ

### **ุงูููุงุฆุฏ:**
- โ ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงู
- โ ุขูู ูุน ุงููุณุฎ ุงูุงุญุชูุงุทู
- โ ุณูู ุงูุงุณุชุฎุฏุงู
- โ ูุงุจู ููุงุณุชุฑุฌุงุน ุงููุงูู

### **ุงูุงุณุชุฎุฏุงู:**
```
ุชูุนูู โ ุชูุณูุน โ ุงุฎุชุจุงุฑ โ ุงุณุชุฑุฌุงุน โ ุญุฐู ุงููุณุฎ
```

### **ุงูุญูุงูุฉ:**
- ๐ Feature Flag
- ๐ Security Rules
- ๐ Logs ุดุงููุฉ
- ๐ ูุณุฎ ุงุญุชูุงุทูุฉ

---

**โ๏ธ ุชุฐููุฑ: ูุฐุง ููุงุฎุชุจุงุฑ ููุท! ุงุณุชุฎุฏู ุจุญุฐุฑ.**

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-25
