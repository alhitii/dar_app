# โ ุฅุตูุงุญ ุดุงูู: ุนุฏู ุธููุฑ ุงูููุงุฏ ูููุนูู

## ๐ ุงููุดููุฉ ุงูุฃุตููุฉ

**ุงููุตู:** ุจุนุฏ ุฅูุดุงุก ุญุณุงุจ ูุนูู ูุฑุจุท ููุงุฏ ููุ ูุง ุชุธูุฑ ุงูููุงุฏ ูู ุตูุญุฉ ุฅุฑุณุงู ูุงุฌุจ.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ุงูููุฏ ูุงู ูุญุงูู ุงููุฑุงุกุฉ ูู `users` collection
- ุงููุนูููู ูุญููุธูู ูู `teachers` collection
- ุนุฏู ูุฌูุฏ ุขููุฉ fallback ูุชุญููู ูู `users_emails`

---

## โ ุงูุญู ุงูุดุงูู ุงูููููุฐ

### 1๏ธโฃ **ุฅุตูุงุญ ุชุญููู ุงูููุงุฏ**

**ุงูููู:** `lib/ui/teacher/home_screen.dart`

**ุงูุชุญุณููุงุช:**

#### **ุฃ. ุงุณุชุฑุงุชูุฌูุฉ ุชุญููู ุฐููุฉ:**
```dart
1. ูุญุงููุฉ ุชุญููู ูู users_emails (ุฃุณุฑุน) โ
2. Fallback ุฅูู teachers collection โ
3. ุงุณุชุฎุฏุงู Cache ุนูุฏ ุงููุดู โ
4. ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ โ
```

#### **ุจ. Debug Logs ุดุงููุฉ:**
```dart
๐ UID ุงููุนูู: xyz123
๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: teacher@school.com
๐ ุจูุงูุงุช users_emails: name, email, role, subjects, ...
โ ุชู ุงูุนุซูุฑ ุนูู 3 ูุงุฏุฉ ูู users_emails
๐ IDs ุงูููุงุฏ: math, science, arabic
โ ุชู ุงูุนุซูุฑ ุนูู 3 ูุงุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```

#### **ุฌ. ูุนุงูุฌุฉ ุงูุญุงูุงุช ุงูุฎุงุตุฉ:**
```dart
// ูุง ุชูุฌุฏ ููุงุฏ
โ ูุง ุชูุฌุฏ ููุงุฏ ูุฎุตุตุฉ ูู. ุฑุงุฌุน ุงูุฅุฏุงุฑุฉ.

// IDs ุบูุฑ ุตุญูุญุฉ
โ๏ธ ูุนุฑููุงุช ุงูููุงุฏ ูุง ุชุทุงุจู ูุซุงุฆู subjects
```

---

### 2๏ธโฃ **ุณูุฑุจุช ุชููุฆุฉ ุงูููุงุฏ**

**ุงูููู:** `lib/utils/setup_teacher_subjects_fix.dart`

**ุงููุธุงุฆู ุงููุชุงุญุฉ:**

#### **ุฃ. ุฅุนุฏุงุฏ ููุงุฏ ููุนูู ูุงุญุฏ:**
```dart
await SetupTeacherSubjectsFix.setupTeacherSubjects(
  teacherEmail: 'teacher@school.com',
  subjectIds: ['math', 'science', 'arabic'], // ุงุฎุชูุงุฑู
);
```

#### **ุจ. ุฅุนุฏุงุฏ ููุงุฏ ูุฌููุน ุงููุนูููู:**
```dart
await SetupTeacherSubjectsFix.setupAllTeachersWithoutSubjects();
```

**ุงููุชูุฌุฉ:**
```
๐ง ุจุฏุก ุฅุนุฏุงุฏ ุงูููุงุฏ ูุฌููุน ุงููุนูููู...
๐ ุนุฏุฏ ุงููุนูููู: 5
โ ุงููุนูู teacher1@school.com ูุฏูู 3 ูุงุฏุฉ ุจุงููุนู
๐ง ุชุนููู ููุงุฏ ูููุนูู teacher2@school.com
โ ุชู ุฅุนุฏุงุฏ ุงูููุงุฏ ุจูุฌุงุญ

โ ุงูุชูู ุงูุฅุนุฏุงุฏ:
   - ุชู ุชุญุฏูุซ: 2 ูุนูู
   - ุชู ุชุฎุทู: 3 ูุนูู
```

#### **ุฌ. ุนุฑุถ ูุนูููุงุช ูุนูู:**
```dart
await SetupTeacherSubjectsFix.showTeacherInfo('teacher@school.com');
```

**ุงููุชูุฌุฉ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ูุนูููุงุช ุงููุนูู: teacher@school.com
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ง users_emails:
   - ุงูุงุณู: ุฃุญูุฏ ูุญูุฏ
   - ุงูุฏูุฑ: teacher
   - ุงูููุงุฏ: [math, science, arabic]

๐จโ๐ซ teachers:
   - ุงูุงุณู: ุฃุญูุฏ ูุญูุฏ
   - ุงููุฑุญูุฉ: ุฅุนุฏุงุฏูุฉ
   - ุงูููุงุฏ: [math, science, arabic]
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

### 3๏ธโฃ **ููุงุนุฏ ุฃูุงู Firestore**

**ุงูููู:** `firestore_security_rules_teacher_subjects.txt`

**ุงูุญูุงูุฉ ุงูููุทุจูุฉ:**

#### **ุฃ. ููุน ุฅุฑุณุงู ูุงุฌุจ ุฎุงุฑุฌ ุงูููุงุฏ:**
```javascript
match /homework/{homeworkId} {
  allow create: if request.auth != null 
                && isTeacher()
                && teacherHasSubject(request.resource.data.subjectId);
}

function teacherHasSubject(subjectId) {
  let userEmail = request.auth.token.email;
  let userData = get(/databases/$(database)/documents/users_emails/$(userEmail)).data;
  
  return userData.subjects != null 
         && subjectId in userData.subjects;
}
```

#### **ุจ. ุณุฌูุงุช ุงูุฃูุงู:**
```javascript
match /security_logs/{logId} {
  allow read: if request.auth != null && isAdmin();
  allow create: if request.auth != null;
  allow update, delete: if false; // ูุง ูููู ุชุนุฏูู ุงูุณุฌูุงุช
}
```

**ูุดุฑ ุงูููุงุนุฏ:**
```bash
firebase deploy --only firestore:rules
```

---

### 4๏ธโฃ **ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู**

#### **ุฃ. ุญุงูุฉ ุงูุชุญููู:**
```
โณ ุฌุงุฑู ุชุญููู ุงูููุงุฏ...
```

#### **ุจ. ูุง ุชูุฌุฏ ููุงุฏ:**
```
๐ ูุง ุชูุฌุฏ ููุงุฏ ูุฎุตุตุฉ ูู

ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ูุชุนููู ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ ุงูุฎุงุตุฉ ุจู

[๐ค ุฅุฑุณุงู ุทูุจ ููุฅุฏุงุฑุฉ]
```

#### **ุฌ. ูุงุฆูุฉ ุงูููุงุฏ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงุฎุชุฑ ุงููุงุฏุฉ (3 ูุชุงุญุฉ)      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ ๐ข ุงูุฑูุงุถูุงุช               โ
โ ๐ฌ ุงูุนููู                  โ
โ ๐ ุงููุบุฉ ุงูุนุฑุจูุฉ           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ง ููููุฉ ุงูุงุณุชุฎุฏุงู

### **ุงูุณููุงุฑูู 1: ุฅูุดุงุก ูุนูู ุฌุฏูุฏ**

#### **ุนุจุฑ ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ:**
1. ุงูุชุญ ููุญุฉ ุงูุฅุฏุงุฑุฉ
2. ุชุจููุจ "ูุนูู"
3. ุงููุฃ ุงูุจูุงูุงุช
4. **ุงุฎุชุฑ ุงูููุงุฏ** ูู ุงููุงุฆูุฉ โ
5. ุงุถุบุท "ุฅูุดุงุก"

**ุงููุชูุฌุฉ:** ุงููุนูู ูููุดุฃ ูุน ููุงุฏ ูุจุงุดุฑุฉ

---

### **ุงูุณููุงุฑูู 2: ูุนูู ููุฌูุฏ ุจุฏูู ููุงุฏ**

#### **ุงูุทุฑููุฉ 1: ุนุจุฑ ุณูุฑุจุช ุงูุชููุฆุฉ**

```dart
// ูู main.dart ุฃู ููู ูููุตู
import 'lib/utils/setup_teacher_subjects_fix.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  
  // ุชุดุบูู ุงูุณูุฑุจุช
  await SetupTeacherSubjectsFix.setupTeacherSubjects(
    teacherEmail: 'teacher@school.com',
    subjectIds: ['math', 'science'],
  );
  
  runApp(MyApp());
}
```

#### **ุงูุทุฑููุฉ 2: ุนุจุฑ ุชุนุฏูู ุงููุนูู**

1. ููุญุฉ ุงูุฅุฏุงุฑุฉ โ "ุงููุนูููู"
2. ุงุถุบุท โฎ ุนูู ุงููุนูู โ "ุชุนุฏูู"
3. ุงุฎุชุฑ ุงูููุงุฏ
4. ุงุญูุธ

---

### **ุงูุณููุงุฑูู 3: ูุนูู ูุทูุจ ููุงุฏ**

#### **ูู ุฌุงูุจ ุงููุนูู:**
1. ุงูุชุญ ุตูุญุฉ "ุฅุฑุณุงู ูุงุฌุจ"
2. ุฅุฐุง ุธูุฑุช "ูุง ุชูุฌุฏ ููุงุฏ"
3. ุงุถุบุท "ุฅุฑุณุงู ุทูุจ ููุฅุฏุงุฑุฉ"
4. ุงูุชุธุฑ ููุงููุฉ ุงูุฅุฏุงุฑุฉ

#### **ูู ุฌุงูุจ ุงูุฅุฏุงุฑุฉ:**
1. ุณุชุตู ุฅุดุนุงุฑ ูู `notifications` collection
2. ุงูุชุญ ููู ุงููุนูู
3. ุนููู ุงูููุงุฏ ุงูููุงุณุจุฉ

---

## ๐ ุจููุฉ ุงูุจูุงูุงุช

### **Collection: `teachers`**
```json
{
  "teacherId": {
    "name": "ุฃุญูุฏ ูุญูุฏ",
    "email": "teacher@school.com",
    "role": "teacher",
    "stage": "ุฅุนุฏุงุฏูุฉ",
    "grade": "ุงูุซุงูุซ",
    "sections": ["ุฃ", "ุจ"],
    "subjects": ["math", "science", "arabic"],
    "isActive": true,
    "createdAt": "2025-01-25T10:00:00Z"
  }
}
```

### **Collection: `users_emails`**
```json
{
  "teacher@school.com": {
    "uid": "xyz123",
    "teacherId": "1234567890",
    "name": "ุฃุญูุฏ ูุญูุฏ",
    "email": "teacher@school.com",
    "role": "teacher",
    "subjects": ["math", "science", "arabic"],
    "sections": ["ุฃ", "ุจ"],
    "isActive": true
  }
}
```

### **Collection: `subjects`**
```json
{
  "math": {
    "name": "ุงูุฑูุงุถูุงุช",
    "emoji": "๐ข"
  },
  "science": {
    "name": "ุงูุนููู",
    "emoji": "๐ฌ"
  }
}
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **1. ุงุฎุชุจุงุฑ ุชุญููู ุงูููุงุฏ:**

```
โ ุณุฌูู ุฏุฎูู ููุนูู ูุฏูู ููุงุฏ
โ ุงูุชุญ ุตูุญุฉ "ุฅุฑุณุงู ูุงุฌุจ"
โ ุชุญูู ูู ุธููุฑ ูุงุฆูุฉ ุงูููุงุฏ
โ ุงุฎุชุฑ ูุงุฏุฉ
โ ุชุญูู ูู ุฅููุงููุฉ ุฅุฑุณุงู ุงููุงุฌุจ
```

### **2. ุงุฎุชุจุงุฑ ุนุฏู ูุฌูุฏ ููุงุฏ:**

```
โ ุณุฌูู ุฏุฎูู ููุนูู ุจุฏูู ููุงุฏ
โ ุงูุชุญ ุตูุญุฉ "ุฅุฑุณุงู ูุงุฌุจ"
โ ุชุญูู ูู ุธููุฑ ุฑุณุงูุฉ "ูุง ุชูุฌุฏ ููุงุฏ"
โ ุงุถุบุท "ุฅุฑุณุงู ุทูุจ ููุฅุฏุงุฑุฉ"
โ ุชุญูู ูู ุฅูุดุงุก notification
```

### **3. ุงุฎุชุจุงุฑ ููุงุนุฏ ุงูุฃูุงู:**

```
โ ุญุงูู ุฅุฑุณุงู ูุงุฌุจ ุนูู ูุงุฏุฉ ุบูุฑ ูุณูุฏุฉ
โ ุชุญูู ูู ุฑูุถ ุงูุนูููุฉ
โ ุชุญูู ูู ุชุณุฌูู ูู security_logs
```

---

## ๐ฏ ูุงุฆูุฉ ุงูุชุญูู (Acceptance Criteria)

- [x] **ูุชุญ ุญุณุงุจ ูุนูู ูุญูู subjects โ**
  - ุชุธูุฑ ูุงุฆูุฉ ุงูููุงุฏ ูุงุจูุฉ ููุงุฎุชูุงุฑ
  
- [x] **ุงุฎุชูุงุฑ ูุงุฏุฉ โ**
  - ูุญุฏูุซ `_selectedSubject`
  - ูููููู ุฒุฑ "ุฅุฑุณุงู ุงููุงุฌุจ"
  
- [x] **ูุง ูููู ุฅุฑุณุงู ูุงุฌุจ ุฎุงุฑุฌ ุงูููุงุฏ โ**
  - Firestore rules ุชููุน ุงูุนูููุฉ
  - ุชุณุฌูู ูู security_logs
  
- [x] **ุฑุณุงุฆู ูุงุถุญุฉ โ**
  - "ูุง ุชูุฌุฏ ููุงุฏ ูุฎุตุตุฉ ูู"
  - "ูุนุฑููุงุช ุงูููุงุฏ ูุง ุชุทุงุจู ูุซุงุฆู subjects"
  
- [x] **Debug logs โ**
  - UIDุ ุงูุจุฑูุฏุ ุนุฏุฏ ุงูููุงุฏุ IDs
  
- [x] **ุณูุฑุจุช ุชููุฆุฉ โ**
  - ุชุนุจุฆุฉ ููุงุฏ ุชุฌุฑูุจูุฉ
  - ุฅุนุฏุงุฏ ุฌููุน ุงููุนูููู

---

## ๐ ููุงุญุธุงุช ูููุฉ

### **1. Collections ุงููุณุชุฎุฏูุฉ:**
```
teachers/       โ ุจูุงูุงุช ุงููุนูููู ุงูุฑุฆูุณูุฉ
users_emails/   โ ููุจุญุซ ูุงูุชุณุฌูู
subjects/       โ ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ
```

### **2. ุญูู subjects:**
```dart
subjects: List<String>  // ูุตูููุฉ ูู IDs
// ูุซุงู: ['math', 'science', 'arabic']
```

### **3. whereIn limit:**
```dart
// Firestore ุชุฏุนู ุญุชู 10 ุนูุงุตุฑ ูู whereIn
.where(FieldPath.documentId, whereIn: ids.take(10).toList())
```

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### **ููุชุทุจูู ูู ุงูุฅูุชุงุฌ:**

1. **ูุดุฑ ุงูููุงุนุฏ:**
   ```bash
   firebase deploy --only firestore:rules
   ```

2. **ุชุดุบูู ุณูุฑุจุช ุงูุชููุฆุฉ:**
   ```dart
   await SetupTeacherSubjectsFix.setupAllTeachersWithoutSubjects();
   ```

3. **ุงุฎุชุจุงุฑ ุดุงูู:**
   - ูุนูู ุฌุฏูุฏ
   - ูุนูู ููุฌูุฏ
   - ูุญุงููุฉ ุบูุฑ ูุฎููุฉ

4. **ูุฑุงูุจุฉ:**
   - `security_logs` ูููุญุงููุงุช ุงููุดุจููุฉ
   - `notifications` ูุทูุจุงุช ุงููุนูููู

---

## โ ุงููููุงุช ุงูููุนุฏููุฉ/ุงููููุดุฃุฉ

| ุงูููู | ุงูููุน | ุงููุตู |
|------|------|-------|
| `lib/ui/teacher/home_screen.dart` | ๐ง ูุนุฏูู | ุฅุตูุงุญ ุชุญููู ุงูููุงุฏ |
| `lib/utils/setup_teacher_subjects_fix.dart` | โจ ุฌุฏูุฏ | ุณูุฑุจุช ุชููุฆุฉ |
| `firestore_security_rules_teacher_subjects.txt` | โจ ุฌุฏูุฏ | ููุงุนุฏ ุฃูุงู |
| `TEACHER_SUBJECTS_COMPLETE_FIX.md` | ๐ ุฌุฏูุฏ | ูุฐุง ุงูููู |

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### **ูุจู ุงูุฅุตูุงุญ:**
```
โ ูุง ุชุธูุฑ ุงูููุงุฏ
โ ูุง ุชูุฌุฏ ุฑุณุงุฆู ูุงุถุญุฉ
โ ูุง ููุฌุฏ ุณูุฑุจุช ุชููุฆุฉ
โ ูุง ุชูุฌุฏ ุญูุงูุฉ ุฃูููุฉ
```

### **ุจุนุฏ ุงูุฅุตูุงุญ:**
```
โ ุงูููุงุฏ ุชุธูุฑ ุจุดูู ุตุญูุญ
โ ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู
โ ุณูุฑุจุช ุชููุฆุฉ ุฌุงูุฒ
โ ููุงุนุฏ ุฃูุงู ูุญููุฉ
โ Debug logs ุดุงููุฉ
โ Cache ุฐูู
โ Fallback ุขูู
```

---

**ุงูุญุงูุฉ:** โ **ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ**

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-01-25
