# ๐ฏ ุฅุตูุงุญ ุดุงูู: ุชุญููู ุงูููุงุฏ ุฏููุงููููุงู

## ๐ ุงููุดููุฉ

ุนูุฏ ุชุนุฏูู ุจูุงูุงุช ุงููุนูู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ:
- โ ุชุธูุฑ **ุงูููุงุฏ ุงููุฏููุฉ** ููุท (hardcoded ุฃู ูู cache)
- โ ุงูููุงุฏ **ุงูุฌุฏูุฏุฉ** ุงููุถุงูุฉ ููู ุตู **ูุง ุชุธูุฑ**
- โ ูุง ูุชู **ุชุญุฏูุซ ุงููุงุฆูุฉ** ูู Firestore ุฏููุงููููุงู
- โ ุงูููุงุฏ ุงููุฏููุฉ ุชุจูู ุญุชู ุจุนุฏ ุงูุญูุธ

---

## โ ุงูุญู ุงูููุทุจูู

### 1๏ธโฃ ุชุญุฏูุซ `edit_teacher_dialog.dart`

#### **ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:**

**ูุจู:**
```dart
// โ ูุงู ูุฌูุจ ุฌููุน ุงูููุงุฏ ุจุฏูู ููุชุฑุฉ
Future<void> _loadAvailableSubjects() async {
  final snapshot = await FirebaseFirestore.instance
      .collection('subjects')
      .get(); // ุฌููุน ุงูููุงุฏ!
}

// โ ูุงู ูุฃุฎุฐ ุงูููุงุฏ ุงููุฏููุฉ ูู ุงูุจูุงูุงุช
_selectedSubjects = subjectsData.cast<String>();
```

**ุจุนุฏ:**
```dart
// โ ูุฌูุจ ุงูููุงุฏ ุญุณุจ ุงููุฑุญูุฉ ูุงูุตู ูุงููุฑุน
Future<void> _loadAvailableSubjects() async {
  Query query = FirebaseFirestore.instance.collection('subjects');
  
  query = query.where('stage', isEqualTo: _selectedStage);
  query = query.where('grade', isEqualTo: _selectedGrade);
  
  if (_selectedStage == 'ุฅุนุฏุงุฏูุฉ' && _selectedBranch != null) {
    query = query.where('branch', isEqualTo: _selectedBranch);
  }
  
  final snapshot = await query.get();
  // ุงูููุงุฏ ุงูุตุญูุญุฉ ููุท!
}

// โ ูุชุฌุงูู ุงูููุงุฏ ุงููุฏููุฉ ุชูุงูุงู
_selectedSubjects = []; // ูุงุฆูุฉ ูุงุฑุบุฉ - ุณูุชู ุชุญููููุง ูู Firestore
```

#### **ุฅุนุงุฏุฉ ุงูุชุญููู ุนูุฏ ุงูุชุบููุฑ:**

```dart
// ุนูุฏ ุชุบููุฑ ุงูุตู
DropdownButtonFormField<String>(
  onChanged: (value) {
    setState(() {
      _selectedGrade = value;
    });
    // โ ุฅุนุงุฏุฉ ุชุญููู ุงูููุงุฏ ููุฑุงู
    _loadAvailableSubjects();
  },
)

// ุนูุฏ ุชุบููุฑ ุงููุฑุน
DropdownButtonFormField<String>(
  onChanged: (value) {
    setState(() {
      _selectedBranch = value;
    });
    // โ ุฅุนุงุฏุฉ ุชุญููู ุงูููุงุฏ ููุฅุนุฏุงุฏูุฉ
    if (_selectedStage == 'ุฅุนุฏุงุฏูุฉ') {
      _loadAvailableSubjects();
    }
  },
)
```

#### **ุญูุธ ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ููุท (ุงุณุชุจุฏุงู ูุงูู):**

```dart
// ูุจู: โ
await FirebaseFirestore.instance
    .collection('users_emails')
    .doc(email)
    .set({...}, SetOptions(merge: true)); // merge ูุญูุธ ุงูููุงุฏ ุงููุฏููุฉ!

// ุจุนุฏ: โ
await FirebaseFirestore.instance
    .collection('users_emails')
    .doc(email)
    .set({...}); // ุงุณุชุจุฏุงู ูุงูู - ุญุฐู ุงูููุงุฏ ุงููุฏููุฉ!
```

---

### 2๏ธโฃ ุณูุฑูุจุช ุฅุตูุงุญ ุงูููุงุฏ ุงููุฏููุฉ

**ุงูููู:** `lib/utils/fix_old_subjects.dart`

**ุงููุธููุฉ:**
- ููุญุต ุฌููุน ุงููุนูููู ูู `users_emails`
- ูุญุฏุฏ ุงููุฑุญูุฉ ูุงูุตู ูุงููุฑุน ููู ูุนูู
- ูุฌูุจ ุงูููุงุฏ **ุงูุตุญูุญุฉ** ูู Firestore
- ูุณุชุจุฏู ุงูููุงุฏ ุงููุฏููุฉ ุจุงูุฌุฏูุฏุฉ (replace ูุงูู)

**ุงูุงุณุชุฎุฏุงู:**
```dart
final result = await FixOldSubjects.fixAllTeachers();
```

---

### 3๏ธโฃ ุฒุฑ ุงูุฅุตูุงุญ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

**ุงูููู:** `lib/ui/admin/fix_old_subjects_button.dart`

**ุงููุงุฌูุฉ:**
```dart
FixOldSubjectsButton() // ููุถุงู ูู admin panel
```

**ุงููููุฒุงุช:**
- โ ูุงุฌูุฉ ูุงุถุญุฉ ูุน ุชุญุฐูุฑุงุช
- โ ุนุฑุถ loading ุฃุซูุงุก ุงูุชุดุบูู
- โ ูุชุงุฆุฌ ุชูุตูููุฉ (ูุฌุญ/ูุดู/ุชุญุฐูุฑุงุช)
- โ ุขูู (ูุทูุจ ุชุฃููุฏ ูุจู ุงูุชุดุบูู)

---

## ๐ ุฎุทูุงุช ุงูุชูููุฐ

### ุงูุฎุทูุฉ 1: ุฅุถุงูุฉ ุฒุฑ ุงูุฅุตูุงุญ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

ูู `lib/ui/admin/admin_tabs_screen.dart` (ุฃู ุฃู ุตูุญุฉ ุฅุฏุงุฑุฉ):

```dart
import 'fix_old_subjects_button.dart';

// ูู body:
FixOldSubjectsButton()
```

---

### ุงูุฎุทูุฉ 2: ุชุดุบูู ุณูุฑูุจุช ุงูุฅุตูุงุญ

1. ุงูุชุญ ุงูุชุทุจูู ููุฏูุฑ
2. ุงุฐูุจ ุฅูู ุงูุตูุญุฉ ุงูุชู ุฃุถูุช ูููุง ุงูุฒุฑ
3. ุงุถุบุท "ุชุดุบูู ุงูุฅุตูุงุญ"
4. ุงูุฑุฃ ุงูุชุญุฐูุฑุงุช
5. ุงุถุบุท "ุชุดุบูู ุงูุฅุตูุงุญ" ููุชุฃููุฏ
6. ุงูุชุธุฑ ุญุชู ููุชูู (ูุฏ ูุณุชุบุฑู ุฏูุงุฆู)
7. ุฑุงุฌุน ุงููุชุงุฆุฌ

**ูุซุงู ุนูู ุงููุชุงุฆุฌ:**
```
๐ ููุฎุต ุงููุชุงุฆุฌ
โโโโโโโโโโโโโโโโโโโ
ุฅุฌูุงูู ุงููุนูููู: 15
ุชู ุฅุตูุงุญูู: 12
ุชู ุชุฎุทููู: 3
ุฃุฎุทุงุก: 0
ุชุญุฐูุฑุงุช: 3
```

---

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุชุนุฏูู ูุนูู

1. ุงุฐูุจ ุฅูู ูุงุฆูุฉ ุงููุนูููู
2. ุงุฎุชุฑ ูุนูู โ **ุชุนุฏูู**
3. **ุบููุฑ ุงูุตู** ูู Dropdown
4. **ูุงุญุธ:** ุงูููุงุฏ ุชุชุญุฏุซ ููุฑุงู! โ
5. ุงุฎุชุฑ ุงูููุงุฏ ุงูุฌุฏูุฏุฉ
6. **ุงุญูุธ**
7. ุชุญูู ูู Firestore

**ูู Firestore ูุฌุจ ุฃู ุชุฑู:**
```json
users_emails/{email} {
  "subjects": ["newId1", "newId2"],  // โ ุฌุฏูุฏุฉ ููุท
  "updatedAt": "2025-10-25T..."
}
```

---

### ุงูุฎุทูุฉ 4: ุงุฎุชุจุงุฑ ูุงุฌูุฉ ุงููุนูู

1. ุณุฌูู ุฏุฎูู ููุนูู
2. ุงูุชุญ ุตูุญุฉ ุฅูุดุงุก ุงููุงุฌุจ
3. **ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููููุงุฏ ูุฌุจ ุฃู ุชุนุฑุถ ุงูููุงุฏ ุงูุฌุฏูุฏุฉ** โ
4. ุญุงูู ุฅุฑุณุงู ูุงุฌุจ โ ูุฌุจ ุฃู ููุฌุญ โ

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### โ ุณููุงุฑูู 1: ุชุบููุฑ ุงูุตู
1. ุงูุชุญ ุชุนุฏูู ูุนูู
2. ุงูุตู ุงูุญุงูู: "ุงูุฃูู"
3. ุงูููุงุฏ ุงููุนุฑูุถุฉ: ููุงุฏ ุงูุตู ุงูุฃูู โ
4. ุบููุฑ ุฅูู "ุงูุซุงูู"
5. **ุงูููุงุฏ ุชุชุญุฏุซ ููุฑุงู** ุฅูู ููุงุฏ ุงูุตู ุงูุซุงูู โ

### โ ุณููุงุฑูู 2: ุงููุฑุน (ุฅุนุฏุงุฏูุฉ)
1. ุงููุฑุญูุฉ: "ุฅุนุฏุงุฏูุฉ"
2. ุงูุตู: "ุงูุฑุงุจุน"
3. ุงููุฑุน: "ุนููู"
4. ุงูููุงุฏ: ููููุงุกุ ููุฒูุงุกุ ุฃุญูุงุก... โ
5. ุบููุฑ ุงููุฑุน ุฅูู "ุฃุฏุจู"
6. **ุงูููุงุฏ ุชุชุญุฏุซ:** ุฌุบุฑุงููุฉุ ุชุงุฑูุฎุ ููุณูุฉ... โ

### โ ุณููุงุฑูู 3: ุญูุธ ุจุฏูู ููุงุฏ ูุฏููุฉ
1. ุงูุชุญ ุชุนุฏูู ูุนูู (ูุฏูู ููุงุฏ ูุฏููุฉ)
2. ุบููุฑ ุงูุตู
3. ุงุฎุชุฑ ููุงุฏ ุฌุฏูุฏุฉ
4. ุงุญูุธ
5. ุชุญูู ูู Firestore
6. **ุงูููุงุฏ ุงููุฏููุฉ ุงุฎุชูุช ุชูุงูุงู** โ

---

## ๐ ููููุฉ ุงูุจูุงูุงุช ูู Firestore

### ุงูููุงุฏ (subjects collection):

```json
subjects/{subjectId} {
  "name": "ุงูุฑูุงุถูุงุช",
  "emoji": "๐",
  "stage": "ุงุจุชุฏุงุฆูุฉ",      // โ ูุทููุจ
  "grade": "ุงูุฃูู",          // โ ูุทููุจ
  "branch": null,             // ููุฅุนุฏุงุฏูุฉ ููุท
  "order": 1
}
```

**โ๏ธ ููู:** ูุฌุจ ุฃู ุชุญุชูู **ุฌููุน** ุงูููุงุฏ ุนูู ุญููู `stage` ู `grade`!

### ุงููุนูู (users_emails):

```json
users_emails/{email} {
  "name": "ุฃุญูุฏ ูุญูุฏ",
  "role": "teacher",
  "stage": "ุงุจุชุฏุงุฆูุฉ",       // โ ููุณุชุฎุฏู ููููุชุฑุฉ
  "grade": "ุงูุฃูู",           // โ ููุณุชุฎุฏู ููููุชุฑุฉ
  "branch": null,
  "sections": ["ุฃ", "ุจ"],
  "subjects": ["id1", "id2"]  // โ IDs ูู subjects collection
}
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### โ ุงูููุงุฏ ูุง ุชุธูุฑ ุนูุฏ ูุชุญ ุงูุชุนุฏูู

**ุงูุณุจุจ:** ุงููุฑุญูุฉ/ุงูุตู ุบูุฑ ูุญุฏุฏ

**ุงูุญู:**
1. ุงูุชุญ Console ูุงุจุญุซ ุนู:
   ```
   โ๏ธ ูุง ูููู ุชุญููู ุงูููุงุฏ - ุงููุฑุญูุฉ ุฃู ุงูุตู ุบูุฑ ูุญุฏุฏ
   ```
2. ุชุฃูุฏ ูู ูุฌูุฏ `stage` ู `grade` ูู ุจูุงูุงุช ุงููุนูู
3. ุฅุฐุง ูุงูุช ูุงุฑุบุฉุ ุญุฏุฏูุง ูู Dropdown ูุณุชุธูุฑ ุงูููุงุฏ

---

### โ ุงูููุงุฏ ูุงุฑุบุฉ ุจุนุฏ ุงุฎุชูุงุฑ ุงูุตู

**ุงูุณุจุจ:** ูุง ุชูุฌุฏ ููุงุฏ ููุฐุง ุงูุตู ูู Firestore

**ุงูุญู:**
1. ุงูุชุญ Console ูุงุจุญุซ ุนู:
   ```
   โ๏ธ ูุง ุชูุฌุฏ ููุงุฏ ููุฐุง ุงูุตู ูู Firestore!
   ๐ก ุชุฃูุฏ ูู ุฅุถุงูุฉ ุงูููุงุฏ ููุตู: ุงุจุชุฏุงุฆูุฉ - ุงูุฃูู
   ```
2. ุงุฐูุจ ุฅูู Firestore โ `subjects`
3. ุชุฃูุฏ ูู ูุฌูุฏ ููุงุฏ ุจููุณ `stage` ู `grade`
4. ุฅุฐุง ูู ุชูุฌุฏุ ุฃุถููุง

**ูุซุงู:**
```dart
await FirebaseFirestore.instance.collection('subjects').add({
  'name': 'ุงูุฑูุงุถูุงุช',
  'emoji': '๐',
  'stage': 'ุงุจุชุฏุงุฆูุฉ',
  'grade': 'ุงูุฃูู',
  'order': 1,
});
```

---

### โ ุงูููุงุฏ ุงููุฏููุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ

**ุงูุณุจุจ:** ุชู ุงุณุชุฎุฏุงู `SetOptions(merge: true)`

**ุงูุญู:**
1. ุชุฃูุฏ ูู ุฅุฒุงูุฉ `merge: true` ูู ููุฏ ุงูุญูุธ
2. ุฃู ุดุบูู ุณูุฑูุจุช `FixOldSubjects.fixAllTeachers()`

---

### โ ุณูุฑูุจุช ุงูุฅุตูุงุญ ูุฎุทู ุจุนุถ ุงููุนูููู

**ุงูุณุจุจ:** ุงููุฑุญูุฉ/ุงูุตู ุบูุฑ ูุญุฏุฏ ุฃู ูุง ุชูุฌุฏ ููุงุฏ

**ุงูุญู:**
1. ุฑุงุฌุน ุงูุชุญุฐูุฑุงุช ูู ูุชุงุฆุฌ ุงูุณูุฑูุจุช
2. ุงูุชุญ Console ูุงุจุญุซ ุนู:
   ```
   โ๏ธ ุงููุฑุญูุฉ ุฃู ุงูุตู ุบูุฑ ูุญุฏุฏ - ุชุฎุทู
   ```
3. ุงูุชุญ ุชุนุฏูู ุงููุนูู ูุญุฏุฏ ุงููุฑุญูุฉ ูุงูุตู
4. ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุจุช

---

## ๐ Console Logs ููุชุดุฎูุต

### ุนูุฏ ูุชุญ ุชุนุฏูู ูุนูู:

```
๐ ุชููุฆุฉ ุงูุจูุงูุงุช:
   - ุงููุฑุญูุฉ: ุงุจุชุฏุงุฆูุฉ
   - ุงูุตู: ุงูุฃูู
   - ุงููุฑุน: null
   - ุงูุดุนุจ: [ุฃ, ุจ]
   - ุงูููุงุฏ ุงููุฏููุฉ: ุชู ุชุฌุงูููุง โ

๐ ุชุญููู ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ูู Firestore...
   ุงููุฑุญูุฉ: ุงุจุชุฏุงุฆูุฉ
   ุงูุตู: ุงูุฃูู
   ุงููุฑุน: null
โ ุชู ุงูุนุซูุฑ ุนูู 7 ูุงุฏุฉ
   โข ๐ ุงููุบุฉ ุงูุนุฑุจูุฉ (arabic)
   โข ๐ ุงูุฑูุงุถูุงุช (math)
   โข ๐ฌ ุงูุนููู (science)
   ...
```

### ุนูุฏ ุชุบููุฑ ุงูุตู:

```
๐ ุชุญููู ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ูู Firestore...
   ุงููุฑุญูุฉ: ุงุจุชุฏุงุฆูุฉ
   ุงูุตู: ุงูุซุงูู
   ุงููุฑุน: null
โ ุชู ุงูุนุซูุฑ ุนูู 8 ูุงุฏุฉ
   ...
```

### ุนูุฏ ุงูุญูุธ:

```
โ ุชู ุญูุธ ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ููุท:
   ุงูููุงุฏ: [id1, id2, id3]
   ุงูุดุนุจ: [ุฃ, ุจ]
```

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

- [ ] ุชู ุชุญุฏูุซ `edit_teacher_dialog.dart`
- [ ] ุชู ุฅูุดุงุก `fix_old_subjects.dart`
- [ ] ุชู ุฅูุดุงุก `fix_old_subjects_button.dart`
- [ ] ุชู ุฅุถุงูุฉ ุงูุฒุฑ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
- [ ] ุชู ุชุดุบูู ุณูุฑูุจุช ุงูุฅุตูุงุญ
- [ ] ุชู ุงุฎุชุจุงุฑ ุชุนุฏูู ูุนูู
- [ ] ุงูููุงุฏ ุชุชุญุฏุซ ุนูุฏ ุชุบููุฑ ุงูุตู โ
- [ ] ุชู ุงุฎุชุจุงุฑ ุงูุญูุธ
- [ ] ุงูููุงุฏ ุงููุฏููุฉ ุงุฎุชูุช ูู Firestore โ
- [ ] ุชู ุงุฎุชุจุงุฑ ูุงุฌูุฉ ุงููุนูู
- [ ] ุงูููุงุฏ ุงูุฌุฏูุฏุฉ ุชุธูุฑ ุจุดูู ุตุญูุญ โ

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ูุจู ุงูุญู:
```
โ ููุงุฏ ูุฏููุฉ (hardcoded)
โ ูุง ุชุชุญุฏุซ ุนูุฏ ุชุบููุฑ ุงูุตู
โ ุชุจูู ูู Firestore ุจุนุฏ ุงูุญูุธ
```

### ุจุนุฏ ุงูุญู:
```
โ ููุงุฏ ุฏููุงููููุฉ ูู Firestore
โ ุชุชุญุฏุซ ููุฑุงู ุนูุฏ ุชุบููุฑ ุงูุตู/ุงููุฑุน
โ ุงุณุชุจุฏุงู ูุงูู (ุญุฐู ุงููุฏููุฉ)
โ ูุงุฌูุฉ ุงููุนูู ุชุนูู ุจุดูู ุตุญูุญ
```

---

**ุชุงุฑูุฎ ุงูุญู:** 2025-10-25  
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ

**ููุงุญุธุฉ:** ุจุนุฏ ุชุทุจูู ุงูุญูุ ูููุตุญ ุงููุนูููู ุจุชุณุฌูู ุฎุฑูุฌ ูุฅุนุงุฏุฉ ุฏุฎูู ูุฑุคูุฉ ุงูุชุญุฏูุซุงุช.
